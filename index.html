<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>AR Object Placement</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            color: white;
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }
        
        #startButton {
            padding: 15px 30px;
            font-size: 18px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        #startButton:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }
        
        #startButton:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        #status {
            margin: 15px 0;
            font-size: 16px;
            line-height: 1.4;
        }
        
        #instructions {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0,123,255,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            z-index: 1000;
            display: none;
        }
        
        #controls {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: none;
        }
        
        .control-button {
            padding: 12px 20px;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .control-button:hover {
            background: rgba(255,255,255,1);
        }
        
        canvas {
            display: block;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="ui">
            <h1>AR Object Placement</h1>
            <div id="status">
                <span class="loading"></span>
                Memeriksa dukungan WebXR...
            </div>
            <button id="startButton" disabled>Memuat...</button>
        </div>
        
        <div id="instructions">
            Arahkan kamera ke permukaan datar, lalu ketuk layar untuk menempatkan objek
        </div>
        
        <div id="controls">
            <button class="control-button" id="resetButton">Reset Objek</button>
            <button class="control-button" id="exitButton">Keluar AR</button>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://unpkg.com/three@0.126.0/build/three.js"></script>
    <!-- GLTFLoader -->
    <script src="https://unpkg.com/three@0.126.0/examples/js/loaders/GLTFLoader.js"></script>

    <script>
        // AR Object Placement dengan texture support yang diperbaiki
        class ARObjectPlacement {
            constructor() {
                this.canvas = null;
                this.gl = null;
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.session = null;
                this.referenceSpace = null;
                this.viewerSpace = null;
                this.hitTestSource = null;
                
                // Models
                this.reticle = null;
                this.arObject = null;
                this.placedObjects = [];
                
                this.init();
            }
            
            async init() {
                await this.checkWebXRSupport();
                this.setupEventListeners();
                await this.loadModels();
            }
            
            async checkWebXRSupport() {
                const statusEl = document.getElementById('status');
                const startButton = document.getElementById('startButton');
                
                if (!navigator.xr) {
                    statusEl.innerHTML = '❌ WebXR tidak tersedia di browser ini';
                    startButton.textContent = 'WebXR Tidak Tersedia';
                    return;
                }
                
                try {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (supported) {
                        statusEl.innerHTML = '✅ WebXR AR didukung! Memuat model...';
                        startButton.disabled = false;
                    } else {
                        statusEl.innerHTML = '❌ WebXR AR tidak didukung di perangkat ini';
                        startButton.textContent = 'AR Tidak Didukung';
                    }
                } catch (error) {
                    console.error('Error checking WebXR support:', error);
                    statusEl.innerHTML = '❌ Error memeriksa dukungan WebXR';
                    startButton.textContent = 'Error';
                }
            }
            
            async loadModels() {
                const statusEl = document.getElementById('status');
                const startButton = document.getElementById('startButton');
                
                try {
                    const loader = new THREE.GLTFLoader();
                    
                    // Load reticle
                    const reticleGltf = await this.loadGLTF(loader, 'https://immersive-web.github.io/webxr-samples/media/gltf/reticle/reticle.gltf');
                    this.reticle = reticleGltf.scene;
                    this.reticle.visible = false;
                    
                    // Load AR object - GANTI URL INI DENGAN MODEL GLB ANDA
                    const objectGltf = await this.loadGLTF(loader, 'Astronaut.glb');
                    this.arObject = objectGltf.scene;
                    
                    // PERBAIKAN PENTING: Traverse semua materials untuk memastikan texture muncul
                    this.arObject.traverse((child) => {
                        if (child.isMesh) {
                            // Pastikan material menerima cahaya dengan benar
                            if (child.material) {
                                // Jika array of materials
                                if (Array.isArray(child.material)) {
                                    child.material.forEach(mat => {
                                        mat.needsUpdate = true;
                                        // Untuk texture yang benar
                                        if (mat.map) {
                                            mat.map.encoding = THREE.sRGBEncoding;
                                        }
                                    });
                                } else {
                                    child.material.needsUpdate = true;
                                    // Untuk texture yang benar
                                    if (child.material.map) {
                                        child.material.map.encoding = THREE.sRGBEncoding;
                                    }
                                }
                            }
                            
                            // Cast shadows jika dibutuhkan
                            child.castShadow = true;
                            child.receiveShadow = true;
                        }
                    });
                    
                    statusEl.innerHTML = '✅ Model berhasil dimuat! Siap memulai AR';
                    startButton.textContent = 'Mulai AR';
                    startButton.disabled = false;
                    
                    console.log('Models loaded successfully');
                    console.log('AR Object:', this.arObject);
                    
                } catch (error) {
                    console.error('Error loading models:', error);
                    statusEl.innerHTML = '❌ Gagal memuat model: ' + error.message;
                    startButton.textContent = 'Error Memuat Model';
                }
            }
            
            loadGLTF(loader, url) {
                return new Promise((resolve, reject) => {
                    loader.load(url, resolve, undefined, reject);
                });
            }
            
            setupEventListeners() {
                const startButton = document.getElementById('startButton');
                const resetButton = document.getElementById('resetButton');
                const exitButton = document.getElementById('exitButton');
                
                startButton.addEventListener('click', () => this.startAR());
                resetButton.addEventListener('click', () => this.resetObjects());
                exitButton.addEventListener('click', () => this.exitAR());
            }
            
            async startAR() {
                try {
                    // Setup canvas and WebGL context
                    this.canvas = document.createElement("canvas");
                    document.body.appendChild(this.canvas);
                    this.gl = this.canvas.getContext("webgl", {
                        xrCompatible: true,
                        alpha: true,
                        antialias: true  // PERBAIKAN: Tambahkan antialiasing
                    });
                    
                    if (!this.gl) {
                        throw new Error("WebGL not supported");
                    }
                    
                    // Create scene
                    this.scene = new THREE.Scene();
                    
                    // PERBAIKAN: Tingkatkan intensitas cahaya untuk texture yang lebih terang
                    // Directional light lebih terang
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 1.0);  // Dinaikkan dari 0.3 ke 1.0
                    directionalLight.position.set(10, 15, 10);
                    this.scene.add(directionalLight);
                    
                    // Tambah cahaya dari arah lain
                    const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
                    directionalLight2.position.set(-10, 10, -10);
                    this.scene.add(directionalLight2);
                    
                    // Ambient light lebih terang
                    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);  // Dinaikkan dari 0.4 ke 0.8
                    this.scene.add(ambientLight);
                    
                    // PERBAIKAN: Tambahkan hemisphere light untuk pencahayaan lebih natural
                    const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
                    hemiLight.position.set(0, 20, 0);
                    this.scene.add(hemiLight);
                    
                    // Add reticle to scene
                    this.scene.add(this.reticle);
                    
                    // PERBAIKAN: Setup renderer dengan konfigurasi yang lebih baik untuk texture
                    this.renderer = new THREE.WebGLRenderer({
                        alpha: true,
                        preserveDrawingBuffer: true,
                        canvas: this.canvas,
                        context: this.gl,
                        antialias: true  // PERBAIKAN: Tambahkan antialiasing
                    });
                    this.renderer.autoClear = false;
                    
                    // PERBAIKAN: Set output encoding untuk texture yang benar
                    this.renderer.outputEncoding = THREE.sRGBEncoding;
                    
                    // PERBAIKAN: Enable physically correct lighting
                    this.renderer.physicallyCorrectLights = true;
                    
                    // PERBAIKAN: Set tone mapping untuk exposure yang lebih baik
                    this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
                    this.renderer.toneMappingExposure = 1.0;
                    
                    // Setup camera
                    this.camera = new THREE.PerspectiveCamera();
                    this.camera.matrixAutoUpdate = false;
                    
                    // Request XR session
                    this.session = await navigator.xr.requestSession("immersive-ar", {
                        requiredFeatures: ['hit-test'],
                        optionalFeatures: ['dom-overlay'],
                        domOverlay: { root: document.getElementById('container') }
                    });
                    
                    // Setup session
                    this.session.updateRenderState({
                        baseLayer: new XRWebGLLayer(this.session, this.gl)
                    });
                    
                    // Setup reference spaces
                    this.referenceSpace = await this.session.requestReferenceSpace('local');
                    this.viewerSpace = await this.session.requestReferenceSpace('viewer');
                    
                    // Setup hit test source
                    this.hitTestSource = await this.session.requestHitTestSource({ 
                        space: this.viewerSpace 
                    });
                    
                    // Add event listeners
                    this.session.addEventListener('end', () => this.onSessionEnded());
                    this.session.addEventListener('select', () => this.onSelect());
                    
                    // Start render loop
                    this.session.requestAnimationFrame((time, frame) => this.onXRFrame(time, frame));
                    
                    // Update UI
                    document.getElementById('ui').style.display = 'none';
                    document.getElementById('instructions').style.display = 'block';
                    document.getElementById('controls').style.display = 'block';
                    
                    console.log('AR session started successfully');
                    
                } catch (error) {
                    console.error('Error starting AR:', error);
                    alert('Gagal memulai AR: ' + error.message);
                    this.cleanup();
                }
            }
            
            onXRFrame(time, frame) {
                // Queue next frame
                this.session.requestAnimationFrame((time, frame) => this.onXRFrame(time, frame));
                
                // Bind framebuffer
                this.gl.bindFramebuffer(this.gl.FRAMEBUFFER, this.session.renderState.baseLayer.framebuffer);
                
                // Get viewer pose
                const pose = frame.getViewerPose(this.referenceSpace);
                
                if (pose) {
                    // Clear the scene
                    this.renderer.clear();
                    
                    // Handle hit test
                    this.handleHitTest(frame);
                    
                    // Render each view (typically just one for mobile AR)
                    for (const view of pose.views) {
                        const viewport = this.session.renderState.baseLayer.getViewport(view);
                        this.renderer.setSize(viewport.width, viewport.height);
                        
                        // Update camera
                        this.camera.matrix.fromArray(view.transform.matrix);
                        this.camera.projectionMatrix.fromArray(view.projectionMatrix);
                        this.camera.updateMatrixWorld(true);
                        
                        // Render
                        this.renderer.render(this.scene, this.camera);
                    }
                }
            }
            
            handleHitTest(frame) {
                if (!this.hitTestSource || !this.reticle) return;
                
                const hitTestResults = frame.getHitTestResults(this.hitTestSource);
                
                if (hitTestResults.length > 0) {
                    const hitPose = hitTestResults[0].getPose(this.referenceSpace);
                    
                    this.reticle.visible = true;
                    this.reticle.position.set(
                        hitPose.transform.position.x,
                        hitPose.transform.position.y,
                        hitPose.transform.position.z
                    );
                    this.reticle.updateMatrixWorld(true);
                } else {
                    this.reticle.visible = false;
                }
            }
            
            onSelect() {
                if (!this.reticle.visible || !this.arObject) return;
                
                // Clone the AR object
                const clone = this.arObject.clone();
                clone.position.copy(this.reticle.position);
                
                // Add some randomness to rotation
                clone.rotation.y = Math.random() * Math.PI * 2;
                
                // Add to scene and tracking array
                this.scene.add(clone);
                this.placedObjects.push(clone);
                
                console.log('Object placed. Total objects:', this.placedObjects.length);
            }
            
            resetObjects() {
                // Remove all placed objects
                this.placedObjects.forEach(object => {
                    this.scene.remove(object);
                });
                this.placedObjects = [];
                console.log('All objects removed');
            }
            
            async exitAR() {
                if (this.session) {
                    await this.session.end();
                }
            }
            
            onSessionEnded() {
                this.cleanup();
                
                // Reset UI
                document.getElementById('ui').style.display = 'block';
                document.getElementById('instructions').style.display = 'none';
                document.getElementById('controls').style.display = 'none';
                
                console.log('AR session ended');
            }
            
            cleanup() {
                // Clean up resources
                if (this.hitTestSource) {
                    this.hitTestSource.cancel();
                    this.hitTestSource = null;
                }
                
                if (this.canvas && this.canvas.parentNode) {
                    this.canvas.parentNode.removeChild(this.canvas);
                    this.canvas = null;
                }
                
                this.session = null;
                this.gl = null;
                this.renderer = null;
                this.referenceSpace = null;
                this.viewerSpace = null;
            }
        }
        
        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            new ARObjectPlacement();
        });
    </script>
</body>
</html>
